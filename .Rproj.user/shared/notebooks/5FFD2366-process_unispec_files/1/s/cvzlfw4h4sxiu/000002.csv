"0","## Average 5 chosen ref measurements per DATE/SITE/BLOCK "
"0","ref_summary <- ref_data %>% "
"0","  group_by(Date,Site,Block,Wavelength) %>% # group_by(Date,Site,Block,Wavelength, int) %>% "
"0","  summarize(ChA_REF = mean(ChA), ChB_REF = mean(ChB), CorrectionFactor_REF = mean(ChA/ChB), int_REF = mean(int), Notes_REF = list(Notes))"
"0","## Join DATA with REFS "
"0","df_ref <- inner_join(df, ref_summary) %>% "
"0","  select(Date, Time, Site, Block, Treatment, Measurement, Wavelength,  int, int_REF, ChB, ChA, ChB_REF, ChA_REF, CorrectionFactor_REF, Weather, Notes, Notes_REF, filename, FileNum, keyname) %>%"
"0","  mutate(raw = ChB/ChA) %>% # the raw reflectance"
"0","  mutate(correct = raw*CorrectionFactor_REF) %>% # this step calculates the corrected reflectance"
"0","  gather(Type, Reflectance, raw:correct) "
"2","Joining, by = c(""Wavelength"", ""Site"", ""Date"", ""Block"")
"
"0","df_tidy <- df_ref %>% "
"0","  mutate(Site = replace(Site, Site %in% WSG, ""WSG"")) %>% # rename WSG1 & WSG23 to WSG"
"0","  mutate(Site = replace(Site, Site %in% SHB, ""SHB"")) %>%  # rename  SHB1 & SHB2 to SHB"
"0","  filter(Type == ""correct"") %>% # drop raw reflectance"
"0","  select(-Type) "
